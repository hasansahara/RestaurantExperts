[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-23 19:11:30.032956",
  "module": "Restaurant Expert",
  "name": "Auto_BOM_Normal",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Auto BOM Consumption for POS - Frappe 16 Safe Script\n\nif doc.is_pos:\n\n    # الحصول على مستودع POS من ملف الـ POS Profile\n    pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n    if not pos_wh:\n        frappe.throw(\"POS Profile لا يحتوي على مستودع مخصص\")\n\n    # إنشاء مستند Stock Entry من نوع Material Issue\n    se = frappe.new_doc(\"Stock Entry\")\n    se.stock_entry_type = \"Material Issue\"\n    se.company = doc.company\n    se.from_warehouse = pos_wh\n    se.reference_doctype = \"Sales Invoice\"\n    se.reference_name = doc.name\n\n    # المرور على كل بند في الفاتورة\n    for row in doc.items:\n        # الحصول على الـ BOM الافتراضي للمنتج\n        bom = frappe.db.get_value(\n            \"BOM\",\n            {\"item\": row.item_code, \"is_default\": 1, \"is_active\": 1},\n            \"name\"\n        )\n        if not bom:\n            continue\n\n        # الحصول على مواد الـ BOM\n        bom_items = frappe.db.get_all(\n            \"BOM Item\",\n            filters={\"parent\": bom},\n            fields=[\"item_code\", \"qty\", \"uom\", \"conversion_factor\"]\n        )\n\n        # إضافة كل مكون من الـ BOM إلى Stock Entry\n        for bi in bom_items:\n            se.append(\"items\", {\n                \"item_code\": bi.item_code,\n                \"qty\": bi.qty * row.qty,\n                \"uom\": bi.uom,\n                \"s_warehouse\": pos_wh\n            })\n\n    # حفظ وإرسال Stock Entry\n    if se.items:\n        se.insert(ignore_permissions=True)\n        se.submit()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-23 19:06:36.505247",
  "module": "Restaurant Expert",
  "name": "Auto_Multi_BOM_Levels",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Auto Multi-level BOM Consumption for POS (Safe Iterative Version)\n\nif doc.is_pos:\n\n    pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n    if not pos_wh:\n        frappe.throw(\"POS Profile لا يحتوي على مستودع مخصص\")\n\n    # إنشاء مستند Stock Entry من نوع Material Issue\n    se = frappe.new_doc(\"Stock Entry\")\n    se.stock_entry_type = \"Material Issue\"\n    se.company = doc.company\n    se.from_warehouse = pos_wh\n    se.reference_doctype = \"Sales Invoice\"\n    se.reference_name = doc.name\n\n    # دالة للحصول على جميع المواد في BOM (Multi-level) بشكل Iterative\n    def get_all_bom_items(item_code, qty):\n        items_to_consume = []\n        queue = [{\"item_code\": item_code, \"qty\": qty}]\n\n        while queue:\n            current = queue.pop(0)\n            bom = frappe.db.get_value(\n                \"BOM\",\n                {\"item\": current[\"item_code\"], \"is_default\": 1, \"is_active\": 1},\n                \"name\"\n            )\n\n            if not bom:\n                # إذا لم يوجد BOM، استهلك المنتج نفسه\n                items_to_consume.append(current)\n                continue\n\n            bom_items = frappe.db.get_all(\n                \"BOM Item\",\n                filters={\"parent\": bom},\n                fields=[\"item_code\", \"qty\"]\n            )\n\n            for bi in bom_items:\n                queue.append({\n                    \"item_code\": bi[\"item_code\"],\n                    \"qty\": bi[\"qty\"] * current[\"qty\"]\n                })\n\n        return items_to_consume\n\n    # المرور على كل بند في الفاتورة\n    for row in doc.items:\n        all_items = get_all_bom_items(row.item_code, row.qty)\n        for item in all_items:\n            se.append(\"items\", {\n                \"item_code\": item[\"item_code\"],\n                \"qty\": item[\"qty\"],\n                \"uom\": \"Nos\",  # يمكن تعديل الـ UOM حسب النظام\n                \"s_warehouse\": pos_wh\n            })\n\n    if se.items:\n        se.insert(ignore_permissions=True)\n        se.submit()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-23 19:33:43.820614",
  "module": "Restaurant Expert",
  "name": "BOM_New_All_Levels",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# الكود الرئيسي\nif doc.doctype == \"Sales Invoice\" and doc.is_pos:\n    try:\n        # الحصول على مستودع POS\n        pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        if not pos_wh:\n            frappe.msgprint(\"تحذير: POS Profile لا يحتوي على مستودع\")\n        else:\n            # قائمة لتخزين المواد المضافة\n            added_materials = {}\n            \n            # المرور على كل بند في الفاتورة\n            for row in doc.items:\n                frappe.log_error(\"معالجة المنتج: \" + str(row.item_code) + \" الكمية: \" + str(row.qty), \"DEBUG BOM\")\n                \n                # الحصول على الـ BOM الافتراضي للمنتج\n                bom = frappe.db.get_value(\n                    \"BOM\",\n                    {\"item\": row.item_code, \"is_default\": 1, \"is_active\": 1},\n                    \"name\"\n                )\n                \n                # إذا كان هناك BOM، استخراج المكونات\n                if bom:\n                    frappe.log_error(\"وجد BOM: \" + str(bom), \"DEBUG BOM\")\n                    \n                    # استخراج مواد BOM\n                    visited_boms = []\n                    bom_queue = [[bom, row.qty]]\n                    \n                    while len(bom_queue) > 0:\n                        queue_item = bom_queue.pop(0)\n                        current_bom = queue_item[0]\n                        current_qty = queue_item[1]\n                        \n                        if current_bom in visited_boms:\n                            continue\n                        visited_boms.append(current_bom)\n                        \n                        # الحصول على مواد BOM الحالي\n                        bom_items = frappe.db.get_all(\n                            \"BOM Item\",\n                            filters={\"parent\": current_bom},\n                            fields=[\"item_code\", \"qty\", \"uom\", \"conversion_factor\"]\n                        )\n                        \n                        frappe.log_error(\"BOM: \" + str(current_bom) + \" يحتوي على \" + str(len(bom_items)) + \" مواد\", \"DEBUG BOM\")\n                        \n                        for item in bom_items:\n                            item_code = item.get(\"item_code\")\n                            item_qty = item.get(\"qty\", 0) * current_qty\n                            \n                            frappe.log_error(\"معالجة المادة: \" + str(item_code) + \" الكمية: \" + str(item_qty), \"DEBUG BOM\")\n                            \n                            # التحقق مما إذا كان المكون يحتوي على BOM\n                            child_bom = frappe.db.get_value(\n                                \"BOM\",\n                                {\"item\": item_code, \"is_default\": 1, \"is_active\": 1},\n                                \"name\"\n                            )\n                            \n                            # إذا كان هناك BOM فرعي، أضفه للقائمة\n                            if child_bom and child_bom not in visited_boms:\n                                frappe.log_error(\"وجد BOM فرعي: \" + str(child_bom), \"DEBUG BOM\")\n                                bom_queue.append([child_bom, item_qty])\n                            else:\n                                # إضافة المادة النهائية\n                                if item_code in added_materials:\n                                    added_materials[item_code][\"qty\"] = added_materials[item_code][\"qty\"] + item_qty\n                                else:\n                                    added_materials[item_code] = {\n                                        \"qty\": item_qty,\n                                        \"uom\": item.get(\"uom\"),\n                                        \"conversion_factor\": item.get(\"conversion_factor\", 1)\n                                    }\n                                frappe.log_error(\"إضافة مادة: \" + str(item_code) + \" الكمية: \" + str(item_qty), \"DEBUG BOM\")\n                else:\n                    # إذا لم يكن هناك BOM، خصم المنتج نفسه\n                    frappe.log_error(\"لا يوجد BOM، خصم المنتج: \" + str(row.item_code), \"DEBUG BOM\")\n                    if row.item_code in added_materials:\n                        added_materials[row.item_code][\"qty\"] = added_materials[row.item_code][\"qty\"] + row.qty\n                    else:\n                        added_materials[row.item_code] = {\n                            \"qty\": row.qty,\n                            \"uom\": row.uom,\n                            \"conversion_factor\": 1\n                        }\n            \n            frappe.log_error(\"إجمالي المواد: \" + str(len(added_materials)) + \" قائمة: \" + str(list(added_materials.keys())), \"DEBUG BOM\")\n            \n            # إذا لم توجد مواد، توقف\n            if not added_materials:\n                frappe.msgprint(\"لا توجد مواد لخصمها\")\n            else:\n                # إنشاء Stock Entry\n                se = frappe.new_doc(\"Stock Entry\")\n                se.stock_entry_type = \"Material Issue\"\n                se.company = doc.company\n                se.from_warehouse = pos_wh\n                se.reference_doctype = \"Sales Invoice\"\n                se.reference_name = doc.name\n                \n                # إضافة المواد\n                items_added = 0\n                \n                for material_code, material_data in added_materials.items():\n                    # التحقق من توفر المادة\n                    available_qty = frappe.db.get_value(\n                        \"Bin\",\n                        {\"warehouse\": pos_wh, \"item_code\": material_code},\n                        \"actual_qty\"\n                    ) or 0\n                    \n                    frappe.log_error(\"مادة: \" + str(material_code) + \" متوفر: \" + str(available_qty) + \" مطلوب: \" + str(material_data[\"qty\"]), \"DEBUG BOM\")\n                    \n                    if available_qty >= material_data[\"qty\"]:\n                        se.append(\"items\", {\n                            \"item_code\": material_code,\n                            \"qty\": material_data[\"qty\"],\n                            \"uom\": material_data[\"uom\"]\n                        })\n                        items_added = items_added + 1\n                        frappe.log_error(\"تم إضافة: \" + str(material_code), \"DEBUG BOM\")\n                    else:\n                        frappe.log_error(\"تم تخطي (غير متوفر): \" + str(material_code), \"DEBUG BOM\")\n                \n                frappe.log_error(\"عدد المواد المضافة: \" + str(items_added), \"DEBUG BOM\")\n                \n                # حفظ وإرسال Stock Entry\n                if se.items and len(se.items) > 0:\n                    se.insert(ignore_permissions=True)\n                    se.submit()\n                    frappe.msgprint(\"تم خصم \" + str(len(se.items)) + \" مواد: \" + str(se.name))\n                else:\n                    frappe.msgprint(\"لم يتم إضافة أي مواد\")\n    \n    except Exception as e:\n        frappe.log_error(\"خطأ BOM: \" + str(e), \"BOM Consumption Error\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-23 19:40:53.265933",
  "module": "Restaurant Expert",
  "name": "Auto BOM Consumption - Multi Level Support",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# الكود الرئيسي\nif doc.doctype == \"Sales Invoice\" and doc.is_pos:\n    try:\n        # الحصول على مستودع POS\n        pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        if not pos_wh:\n            frappe.msgprint(\"تحذير: POS Profile لا يحتوي على مستودع\")\n        else:\n            # قائمة واحدة لتخزين جميع المواد من كل الفاتورة\n            added_materials = {}\n            \n            # المرور على كل بند في الفاتورة\n            for row in doc.items:\n                frappe.log_error(\"معالجة المنتج: \" + str(row.item_code) + \" الكمية: \" + str(row.qty), \"DEBUG BOM\")\n                \n                # الحصول على الـ BOM الافتراضي للمنتج\n                bom = frappe.db.get_value(\n                    \"BOM\",\n                    {\"item\": row.item_code, \"is_default\": 1, \"is_active\": 1},\n                    \"name\"\n                )\n                \n                # إذا كان هناك BOM، استخراج المكونات\n                if bom:\n                    frappe.log_error(\"وجد BOM: \" + str(bom), \"DEBUG BOM\")\n                    \n                    # استخراج مواد BOM\n                    visited_boms = []\n                    bom_queue = [[bom, row.qty]]\n                    \n                    while len(bom_queue) > 0:\n                        queue_item = bom_queue.pop(0)\n                        current_bom = queue_item[0]\n                        current_qty = queue_item[1]\n                        \n                        if current_bom in visited_boms:\n                            continue\n                        visited_boms.append(current_bom)\n                        \n                        # الحصول على مواد BOM الحالي\n                        bom_items = frappe.db.get_all(\n                            \"BOM Item\",\n                            filters={\"parent\": current_bom},\n                            fields=[\"item_code\", \"qty\", \"uom\", \"conversion_factor\"]\n                        )\n                        \n                        frappe.log_error(\"BOM: \" + str(current_bom) + \" يحتوي على \" + str(len(bom_items)) + \" مواد\", \"DEBUG BOM\")\n                        \n                        for item in bom_items:\n                            item_code = item.get(\"item_code\")\n                            item_qty = item.get(\"qty\", 0) * current_qty\n                            \n                            frappe.log_error(\"معالجة المادة: \" + str(item_code) + \" الكمية: \" + str(item_qty), \"DEBUG BOM\")\n                            \n                            # التحقق مما إذا كان المكون يحتوي على BOM\n                            child_bom = frappe.db.get_value(\n                                \"BOM\",\n                                {\"item\": item_code, \"is_default\": 1, \"is_active\": 1},\n                                \"name\"\n                            )\n                            \n                            # إذا كان هناك BOM فرعي، أضفه للقائمة\n                            if child_bom and child_bom not in visited_boms:\n                                frappe.log_error(\"وجد BOM فرعي: \" + str(child_bom), \"DEBUG BOM\")\n                                bom_queue.append([child_bom, item_qty])\n                            else:\n                                # إضافة المادة النهائية (تجميع الكميات إذا ظهرت مرة أخرى)\n                                if item_code in added_materials:\n                                    added_materials[item_code][\"qty\"] = added_materials[item_code][\"qty\"] + item_qty\n                                    frappe.log_error(\"تحديث مادة موجودة: \" + str(item_code) + \" الكمية الجديدة: \" + str(added_materials[item_code][\"qty\"]), \"DEBUG BOM\")\n                                else:\n                                    added_materials[item_code] = {\n                                        \"qty\": item_qty,\n                                        \"uom\": item.get(\"uom\"),\n                                        \"conversion_factor\": item.get(\"conversion_factor\", 1)\n                                    }\n                                    frappe.log_error(\"إضافة مادة جديدة: \" + str(item_code) + \" الكمية: \" + str(item_qty), \"DEBUG BOM\")\n                else:\n                    # إذا لم يكن هناك BOM، لا تخصم المنتج نفسه\n                    # (المنتج بدون BOM لا نخصمه من المستودع)\n                    frappe.log_error(\"لا يوجد BOM للمنتج: \" + str(row.item_code) + \" - سيتم تجاهله\", \"DEBUG BOM\")\n            \n            frappe.log_error(\"إجمالي المواد الفريدة: \" + str(len(added_materials)) + \" قائمة: \" + str(list(added_materials.keys())), \"DEBUG BOM\")\n            \n            # إذا لم توجد مواد، توقف\n            if not added_materials:\n                frappe.msgprint(\"لا توجد مواد لخصمها\")\n            else:\n                # إنشاء Stock Entry\n                se = frappe.new_doc(\"Stock Entry\")\n                se.stock_entry_type = \"Material Issue\"\n                se.company = doc.company\n                se.from_warehouse = pos_wh\n                se.reference_doctype = \"Sales Invoice\"\n                se.reference_name = doc.name\n                \n                # إضافة المواد\n                items_added = 0\n                \n                for material_code, material_data in added_materials.items():\n                    # التحقق من توفر المادة\n                    available_qty = frappe.db.get_value(\n                        \"Bin\",\n                        {\"warehouse\": pos_wh, \"item_code\": material_code},\n                        \"actual_qty\"\n                    ) or 0\n                    \n                    frappe.log_error(\"مادة: \" + str(material_code) + \" متوفر: \" + str(available_qty) + \" مطلوب: \" + str(material_data[\"qty\"]), \"DEBUG BOM\")\n                    \n                    if available_qty >= material_data[\"qty\"]:\n                        se.append(\"items\", {\n                            \"item_code\": material_code,\n                            \"qty\": material_data[\"qty\"],\n                            \"uom\": material_data[\"uom\"]\n                        })\n                        items_added = items_added + 1\n                        frappe.log_error(\"تم إضافة: \" + str(material_code), \"DEBUG BOM\")\n                    else:\n                        frappe.log_error(\"تم تخطي (غير متوفر): \" + str(material_code), \"DEBUG BOM\")\n                \n                frappe.log_error(\"عدد المواد المضافة: \" + str(items_added), \"DEBUG BOM\")\n                \n                # حفظ وإرسال Stock Entry\n                if se.items and len(se.items) > 0:\n                    se.insert(ignore_permissions=True)\n                    se.submit()\n                    frappe.msgprint(\"تم خصم \" + str(len(se.items)) + \" مادة: \" + str(se.name))\n                else:\n                    frappe.msgprint(\"لم يتم إضافة أي مواد\")\n    \n    except Exception as e:\n        frappe.log_error(\"خطأ BOM: \" + str(e), \"BOM Consumption Error\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-23 21:50:22.998193",
  "module": "Restaurant Expert",
  "name": "BOM Material Consumption - Fixed",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Server Script for Sales Invoice on_submit\n# يتم تشغيله عند اعتماد فاتورة المبيعات من POS\n\nif doc.doctype == \"Sales Invoice\" and doc.is_pos:\n    try:\n        # الحصول على مستودع POS\n        pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        \n        if not pos_wh:\n            frappe.msgprint(\"تحذير: POS Profile لا يحتوي على مستودع\")\n        else:\n            # قاموس لتخزين المواد النهائية مع كمياتها\n            final_materials = {}\n            \n            # المرور على كل بند في الفاتورة\n            for row in doc.items:\n                frappe.log_error(\"=\" * 50, \"BOM Processing\")\n                frappe.log_error(\"بدء معالجة المنتج: \" + str(row.item_code) + \" | الكمية في الفاتورة: \" + str(row.qty), \"BOM Processing\")\n                \n                # الحصول على الـ BOM الافتراضي للمنتج\n                bom = frappe.db.get_value(\n                    \"BOM\",\n                    {\"item\": row.item_code, \"is_default\": 1, \"is_active\": 1},\n                    \"name\"\n                )\n                \n                # إذا لم يكن هناك BOM، تخطي هذا المنتج\n                if not bom:\n                    frappe.log_error(\"لا يوجد BOM للمنتج: \" + str(row.item_code) + \" - سيتم تجاهله\", \"BOM Processing\")\n                    continue\n                \n                frappe.log_error(\"تم العثور على BOM: \" + str(bom) + \" للمنتج: \" + str(row.item_code), \"BOM Processing\")\n                \n                # استخراج جميع المواد من BOM (مع BOMs المتداخلة)\n                # ===============================================\n                materials = {}\n                visited_boms = set()\n                bom_queue = [[bom, row.qty]]\n                \n                while bom_queue:\n                    queue_item = bom_queue.pop(0)\n                    current_bom = queue_item[0]\n                    current_multiplier = queue_item[1]\n                    \n                    # تجنب المعالجة المتكررة لنفس BOM\n                    if current_bom in visited_boms:\n                        frappe.log_error(\"تم تخطي BOM متكرر: \" + str(current_bom), \"BOM Processing\")\n                        continue\n                    \n                    visited_boms.add(current_bom)\n                    frappe.log_error(\"معالجة BOM: \" + str(current_bom) + \" | المضاعف: \" + str(current_multiplier), \"BOM Processing\")\n                    \n                    # الحصول على مواد BOM الحالي\n                    bom_items = frappe.db.get_all(\n                        \"BOM Item\",\n                        filters={\"parent\": current_bom},\n                        fields=[\"item_code\", \"qty\", \"stock_qty\", \"uom\", \"stock_uom\"]\n                    )\n                    \n                    frappe.log_error(\"BOM: \" + str(current_bom) + \" يحتوي على \" + str(len(bom_items)) + \" مادة\", \"BOM Processing\")\n                    \n                    for item in bom_items:\n                        item_code = item.get(\"item_code\")\n                        \n                        # تسجيل جميع القيم للتحليل\n                        frappe.log_error(\"  --- تفاصيل المادة ---\", \"BOM Processing\")\n                        frappe.log_error(\"  item_code: \" + str(item_code), \"BOM Processing\")\n                        frappe.log_error(\"  qty من BOM: \" + str(item.get(\"qty\")), \"BOM Processing\")\n                        frappe.log_error(\"  stock_qty من BOM: \" + str(item.get(\"stock_qty\")), \"BOM Processing\")\n                        frappe.log_error(\"  uom: \" + str(item.get(\"uom\")), \"BOM Processing\")\n                        frappe.log_error(\"  stock_uom: \" + str(item.get(\"stock_uom\")), \"BOM Processing\")\n                        frappe.log_error(\"  current_multiplier (كمية المنتج): \" + str(current_multiplier), \"BOM Processing\")\n                        \n                        # استخدام qty (الكمية الأساسية في BOM) وليس stock_qty\n                        base_qty = item.get(\"qty\", 0)\n                        item_qty = base_qty * current_multiplier\n                        \n                        frappe.log_error(\"  الحساب: \" + str(base_qty) + \" × \" + str(current_multiplier) + \" = \" + str(item_qty), \"BOM Processing\")\n                        \n                        # التحقق من وجود BOM فرعي لهذه المادة\n                        child_bom = frappe.db.get_value(\n                            \"BOM\",\n                            {\"item\": item_code, \"is_default\": 1, \"is_active\": 1},\n                            \"name\"\n                        )\n                        \n                        if child_bom and child_bom not in visited_boms:\n                            # إذا كان هناك BOM فرعي، أضفه للقائمة للمعالجة\n                            frappe.log_error(\"  وجد BOM فرعي: \" + str(child_bom) + \" للمادة: \" + str(item_code), \"BOM Processing\")\n                            bom_queue.append([child_bom, item_qty])\n                        else:\n                            # مادة نهائية - أضفها للقاموس\n                            if item_code in materials:\n                                materials[item_code] = materials[item_code] + item_qty\n                            else:\n                                materials[item_code] = item_qty\n                            \n                            frappe.log_error(\"  مادة نهائية: \" + str(item_code) + \" | الكمية المجمعة: \" + str(materials[item_code]), \"BOM Processing\")\n                # ===============================================\n                \n                # دمج المواد في القاموس النهائي\n                frappe.log_error(\"--- دمج المواد من BOM: \" + str(bom) + \" ---\", \"BOM Processing\")\n                for material_item in materials.items():\n                    item_code = material_item[0]\n                    qty = material_item[1]\n                    \n                    frappe.log_error(\"دمج المادة: \" + str(item_code) + \" | الكمية من BOM الحالي: \" + str(qty), \"BOM Processing\")\n                    \n                    if item_code in final_materials:\n                        old_qty = final_materials[item_code]\n                        final_materials[item_code] = final_materials[item_code] + qty\n                        frappe.log_error(\"  تحديث: كان \" + str(old_qty) + \" أصبح \" + str(final_materials[item_code]), \"BOM Processing\")\n                    else:\n                        final_materials[item_code] = qty\n                        frappe.log_error(\"  إضافة جديدة: \" + str(qty), \"BOM Processing\")\n            \n            # التحقق من وجود مواد للخصم\n            if not final_materials:\n                frappe.msgprint(\"لا توجد مواد لخصمها من BOM\")\n            else:\n                frappe.log_error(\"=\" * 50, \"BOM Processing\")\n                frappe.log_error(\"النتيجة النهائية - إجمالي المواد: \" + str(len(final_materials)), \"BOM Processing\")\n                for mat_code, mat_qty in final_materials.items():\n                    frappe.log_error(\"  المادة: \" + str(mat_code) + \" = \" + str(mat_qty), \"BOM Processing\")\n                frappe.log_error(\"=\" * 50, \"BOM Processing\")\n                \n                # إنشاء Stock Entry\n                se = frappe.new_doc(\"Stock Entry\")\n                se.stock_entry_type = \"Material Issue\"\n                se.company = doc.company\n                se.from_warehouse = pos_wh\n                se.reference_doctype = \"Sales Invoice\"\n                se.reference_name = doc.name\n                \n                # إضافة المواد إلى Stock Entry\n                items_added = 0\n                items_skipped = []\n                \n                for material_entry in final_materials.items():\n                    item_code = material_entry[0]\n                    required_qty = material_entry[1]\n                    # الحصول على الكمية المتاحة في المستودع\n                    available_qty = frappe.db.get_value(\n                        \"Bin\",\n                        {\"warehouse\": pos_wh, \"item_code\": item_code},\n                        \"actual_qty\"\n                    ) or 0\n                    \n                    frappe.log_error(\"المادة: \" + str(item_code) + \" | متوفر: \" + str(available_qty) + \" | مطلوب: \" + str(required_qty), \"BOM Stock Check\")\n                    \n                    # التحقق من توفر الكمية\n                    if available_qty >= required_qty:\n                        # الحصول على UOM من Item\n                        item_uom = frappe.db.get_value(\"Item\", item_code, \"stock_uom\")\n                        \n                        se.append(\"items\", {\n                            \"item_code\": item_code,\n                            \"qty\": required_qty,\n                            \"uom\": item_uom,\n                            \"s_warehouse\": pos_wh\n                        })\n                        items_added = items_added + 1\n                        frappe.log_error(\"تمت إضافة المادة: \" + str(item_code) + \" | الكمية: \" + str(required_qty), \"BOM Stock Check\")\n                    else:\n                        items_skipped.append(str(item_code) + \" (متوفر: \" + str(available_qty) + \", مطلوب: \" + str(required_qty) + \")\")\n                        frappe.log_error(\"تم تخطي المادة (غير متوفرة): \" + str(item_code) + \" | متوفر: \" + str(available_qty) + \" | مطلوب: \" + str(required_qty), \"BOM Stock Check\")\n                \n                # حفظ وإرسال Stock Entry\n                if se.items and len(se.items) > 0:\n                    se.insert(ignore_permissions=True)\n                    se.submit()\n                    \n                    success_msg = \"تم خصم \" + str(len(se.items)) + \" مادة بنجاح<br>Stock Entry: \" + str(se.name)\n                    if items_skipped:\n                        success_msg = success_msg + \"<br><br>تم تخطي \" + str(len(items_skipped)) + \" مادة لعدم توفرها:<br>\" + \"<br>\".join(items_skipped)\n                    \n                    frappe.msgprint(success_msg, title=\"نتيجة خصم المواد\", indicator=\"green\")\n                    frappe.log_error(\"تم إنشاء Stock Entry بنجاح: \" + str(se.name) + \" | عدد المواد: \" + str(len(se.items)), \"BOM Processing\")\n                else:\n                    frappe.msgprint(\"لم يتم إضافة أي مواد - جميع المواد غير متوفرة في المستودع\", title=\"تحذير\", indicator=\"orange\")\n                    frappe.log_error(\"لم يتم إضافة أي مواد إلى Stock Entry\", \"BOM Processing\")\n    \n    except Exception as e:\n        error_msg = \"خطأ في معالجة BOM: \" + str(e)\n        frappe.log_error(error_msg, \"BOM Consumption Error\")\n        frappe.msgprint(\"حدث خطأ أثناء خصم المواد: \" + str(e), title=\"خطأ\", indicator=\"red\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-23 22:24:57.081804",
  "module": "Restaurant Expert",
  "name": "BOM_Consumption_POS",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Server Script: Auto BOM Consumption for POS Sales Invoice\n# يمنع الخصم المكرر للمواد\n\nif doc.doctype == \"Sales Invoice\" and doc.is_pos:\n    try:\n        # ============================================================\n        # 1️⃣ الحصول على مستودع POS\n        # ============================================================\n        pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        if not pos_wh:\n            frappe.msgprint(\"تحذير: POS Profile لا يحتوي على مستودع\")\n        else:\n\n            # ============================================================\n            # 2️⃣ قاموس نهائي للمواد + Set لمنع التكرار\n            # ============================================================\n            final_materials = {}\n            processed_items = set()  # لتخزين كل مادة تم خصمها مع المنتج الأصلي\n\n            for row in doc.items:\n                # الحصول على BOM الافتراضي\n                bom = frappe.db.get_value(\n                    \"BOM\",\n                    {\"item\": row.item_code, \"is_default\": 1, \"is_active\": 1},\n                    \"name\"\n                )\n                if not bom:\n                    continue\n\n                # تهيئة قائمة المعالجة لكل منتج\n                bom_queue = [[bom, row.qty]]\n                visited_boms = set()\n\n                while bom_queue:\n                    queue_item = bom_queue.pop(0)\n                    current_bom = queue_item[0]\n                    multiplier = queue_item[1]\n\n                    if current_bom in visited_boms:\n                        continue\n\n                    visited_boms.add(current_bom)\n\n                    # جلب مكونات BOM\n                    bom_items = frappe.db.get_all(\n                        \"BOM Item\",\n                        filters={\"parent\": current_bom},\n                        fields=[\"item_code\", \"qty\"]\n                    )\n\n                    for item in bom_items:\n                        item_code = item.get(\"item_code\")\n                        base_qty = item.get(\"qty\") or 0\n                        required_qty = base_qty * multiplier\n\n                        # منع الخصم المكرر لكل مادة بالنسبة لكل فاتورة\n                        key = f\"{row.item_code}::{item_code}::{current_bom}\"\n                        if key in processed_items:\n                            continue\n                        processed_items.add(key)\n\n                        # التحقق من وجود BOM فرعي\n                        child_bom = frappe.db.get_value(\n                            \"BOM\",\n                            {\"item\": item_code, \"is_default\": 1, \"is_active\": 1},\n                            \"name\"\n                        )\n\n                        if child_bom:\n                            bom_queue.append([child_bom, required_qty])\n                        else:\n                            # مادة نهائية\n                            final_materials[item_code] = final_materials.get(item_code, 0) + required_qty\n\n            # ============================================================\n            # 3️⃣ التحقق من وجود مواد\n            # ============================================================\n            if not final_materials:\n                frappe.msgprint(\"لا توجد مواد لخصمها من BOM\")\n            else:\n                # ============================================================\n                # 4️⃣ إنشاء Stock Entry\n                # ============================================================\n                se = frappe.new_doc(\"Stock Entry\")\n                se.stock_entry_type = \"Material Issue\"\n                se.company = doc.company\n                se.from_warehouse = pos_wh\n                se.reference_doctype = \"Sales Invoice\"\n                se.reference_name = doc.name\n\n                skipped = []\n\n                for item_code, required_qty in final_materials.items():\n                    available_qty = frappe.db.get_value(\n                        \"Bin\",\n                        {\"warehouse\": pos_wh, \"item_code\": item_code},\n                        \"actual_qty\"\n                    ) or 0\n\n                    if available_qty < required_qty:\n                        skipped.append(f\"{item_code} (متوفر: {available_qty}, مطلوب: {required_qty})\")\n                        continue\n\n                    item_uom = frappe.db.get_value(\"Item\", item_code, \"stock_uom\") or \"Unit\"\n\n                    se.append(\"items\", {\n                        \"item_code\": item_code,\n                        \"qty\": required_qty,\n                        \"uom\": item_uom,\n                        \"s_warehouse\": pos_wh\n                    })\n\n                # ============================================================\n                # 5️⃣ حفظ وإرسال Stock Entry\n                # ============================================================\n                if se.items:\n                    se.insert(ignore_permissions=True)\n                    se.submit()\n\n                    msg = (\n                        f\"تم خصم {len(se.items)} مادة بنجاح.<br>\"\n                        f\"Stock Entry: {se.name}\"\n                    )\n                    if skipped:\n                        msg += \"<br><br>مواد لم تُخصم بسبب عدم توفر الكمية:<br>\" + \"<br>\".join(skipped)\n\n                    frappe.msgprint(msg, title=\"نتيجة خصم المواد\", indicator=\"green\")\n                else:\n                    frappe.msgprint(\n                        \"لم يتم خصم أي مواد (جميع المواد غير متوفرة)\",\n                        title=\"تنبيه\",\n                        indicator=\"orange\"\n                    )\n\n    except Exception as e:\n        frappe.log_error(f\"خطأ: {e}\", \"Auto BOM Consumption Error\")\n        frappe.msgprint(f\"حدث خطأ أثناء تنفيذ خصم المواد: {e}\", indicator=\"red\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-24 11:01:41.374051",
  "module": "Restaurant Expert",
  "name": "BOM_Consumption_POS_2",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Server Script: Auto BOM Consumption for POS Sales Invoice\n# يمنع التكرار، يجمع المواد فقط للعناصر المخزنة، ويخصم حتى لو كان المخزون صفر/سالب.\n# ملاحظات: لا تستخدم .format أو tuple-unpacking المحظور داخل Server Script.\n\nif doc.doctype == \"Sales Invoice\" and doc.is_pos:\n    try:\n        # 1) جلب مستودع POS\n        pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        if not pos_wh:\n            frappe.msgprint(\"تحذير: POS Profile لا يحتوي على مستودع\")\n        else:\n            # 2) هياكل البيانات النهائية\n            final_materials = {}        # { item_code: total_qty }\n            processed_items = set()     # لمنع التكرار لكل (product::component::bom)\n            bom_items_cache = {}        # cache لبنود كل BOM\n            child_bom_cache = {}        # cache لبحث BOM فرعي لمادة\n\n            # 3) نمر على كل بند في الفاتورة\n            for row in doc.items:\n                sold_item = row.item_code\n                sold_qty = row.qty or 0\n\n                # الحصول على BOM الافتراضي لهذا المنتج (إن وُجد)\n                bom = frappe.db.get_value(\n                    \"BOM\",\n                    {\"item\": sold_item, \"is_default\": 1, \"is_active\": 1},\n                    \"name\"\n                )\n                if not bom:\n                    # لا يوجد BOM => لا ننفذ أي خصم لمواد لهذا المنتج\n                    continue\n\n                # قائمة معالجة (نستخدم قائمة من القوائم لتجنب tuple-unpacking)\n                bom_queue = [[bom, sold_qty]]\n                visited_boms = set()\n\n                # 4) معالجة BOMs متداخلة بشكل iterative\n                while bom_queue:\n                    queue_item = bom_queue.pop(0)\n                    current_bom = queue_item[0]\n                    multiplier = queue_item[1]\n\n                    # حماية ضد المعالجة المتكررة لنفس BOM\n                    if current_bom in visited_boms:\n                        continue\n                    visited_boms.add(current_bom)\n\n                    # جلب بنود الـ BOM (من الكاش إن وُجد)\n                    if current_bom in bom_items_cache:\n                        bom_items = bom_items_cache[current_bom]\n                    else:\n                        bom_items = frappe.get_all(\n                            \"BOM Item\",\n                            filters={\"parent\": current_bom},\n                            fields=[\"item_code\", \"qty\"]\n                        )\n                        bom_items_cache[current_bom] = bom_items\n\n                    # المرور على كل مادة في هذا BOM\n                    for itm in bom_items:\n                        item_code = itm.get(\"item_code\")\n                        base_qty = itm.get(\"qty\") or 0\n                        required_qty = base_qty * multiplier\n\n                        # تجاهل الكميات الصفرية (تمنع رسالة \"Qty in Stock UOM can not be zero\")\n                        if not required_qty:\n                            continue\n\n                        # مفتاح منع التكرار: يربط المنتج النهائي بالمكوّن و BOM الذي جاء منه\n                        key = sold_item + \"::\" + item_code + \"::\" + str(current_bom)\n                        if key in processed_items:\n                            continue\n                        processed_items.add(key)\n\n                        # التحقق من وجود BOM فرعي لهذا العنصر (من الكاش إن وُجد)\n                        if item_code in child_bom_cache:\n                            child_bom = child_bom_cache[item_code]\n                        else:\n                            child_bom = frappe.db.get_value(\n                                \"BOM\",\n                                {\"item\": item_code, \"is_default\": 1, \"is_active\": 1},\n                                \"name\"\n                            )\n                            child_bom_cache[item_code] = child_bom\n\n                        if child_bom:\n                            # أضف BOM الفرعي للمعالجة (نستخدم قائمة بدل tuple)\n                            bom_queue.append([child_bom, required_qty])\n                        else:\n                            # هذه مادة نهائية؛ نخصمها فقط إذا كانت عنصر مخزون\n                            is_stock_item = frappe.db.get_value(\"Item\", item_code, \"is_stock_item\") or 0\n                            if is_stock_item:\n                                final_materials[item_code] = final_materials.get(item_code, 0) + required_qty\n                            else:\n                                # مادة غير مخزنة => لا تُضاف إلى Stock Entry\n                                # (مثال: المنتج النهائي \"فلافل\" هو non-stock)\n                                pass\n\n            # 5) بعد التجميع: تحقق إن كان هناك مواد لخصمها\n            if not final_materials:\n                frappe.msgprint(\"لا توجد مواد مخزنية لخصمها من BOM لهذه الفاتورة\")\n            else:\n                # 6) إنشاء Stock Entry وإضافة كل المواد مباشرة (نسمح بالسالب)\n                se = frappe.new_doc(\"Stock Entry\")\n                se.stock_entry_type = \"Material Issue\"\n                se.company = doc.company\n                se.from_warehouse = pos_wh\n                se.reference_doctype = \"Sales Invoice\"\n                se.reference_name = doc.name\n\n                for item_code, qty in final_materials.items():\n                    # تأكد من الحصول على UOM التخزين الافتراضي\n                    item_uom = frappe.db.get_value(\"Item\", item_code, \"stock_uom\") or \"Unit\"\n\n                    # إضافة المادة - لا نتحقق من Bin.actual_qty هنا لأننا نسمح بالسالب\n                    se.append(\"items\", {\n                        \"item_code\": item_code,\n                        \"qty\": qty,\n                        \"uom\": item_uom,\n                        \"s_warehouse\": pos_wh\n                    })\n\n                # حفظ وإرسال Stock Entry إن كانت هناك بنود\n                if se.items:\n                    se.insert(ignore_permissions=True)\n                    se.submit()\n                    # رسالة بسيطة للمستخدم\n                    frappe.msgprint(\"تم إنشاء Stock Entry وخصم المواد المخزنية بنجاح. Stock Entry: \" + str(se.name))\n                else:\n                    frappe.msgprint(\"لم يتم إضافة أي بند إلى Stock Entry\")\n\n    except Exception as e:\n        # سجل الخطأ وأظهر رسالة عامة (تجنب استخدام .format هنا)\n        frappe.log_error(\"Auto BOM Consumption Error: \" + str(e), \"bom_consumption_pos\")\n        frappe.msgprint(\"حدث خطأ أثناء تنفيذ خصم المواد: \" + str(e), indicator=\"red\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-05 11:12:00.065358",
  "module": "Restaurant Expert",
  "name": "BOM_Consumption_POS_3",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Server Script: Auto BOM Consumption for POS Sales Invoice\n# يمنع التكرار، يجمع المواد فقط للعناصر المخزنة، ويخصم حتى لو كان المخزون صفر/سالب.\n# ملاحظات: لا تستخدم .format أو tuple-unpacking المحظور داخل Server Script.\n\nif doc.doctype == \"Sales Invoice\" and doc.is_pos:\n    try:\n        # 1) جلب مستودع POS\n        pos_wh = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        if not pos_wh:\n            frappe.msgprint(\"تحذير: POS Profile لا يحتوي على مستودع\")\n        else:\n            # 2) هياكل البيانات النهائية\n            final_materials = {}        # { item_code: total_qty }\n            processed_items = set()     # لمنع التكرار لكل (product::component::bom)\n            bom_items_cache = {}        # cache لبنود كل BOM\n            child_bom_cache = {}        # cache لبحث BOM فرعي لمادة\n\n            # 3) نمر على كل بند في الفاتورة\n            for row in doc.items:\n                sold_item = row.item_code\n                sold_qty = row.qty or 0\n\n                # الحصول على BOM الافتراضي لهذا المنتج (إن وُجد)\n                bom = frappe.db.get_value(\n                    \"BOM\",\n                    {\"item\": sold_item, \"is_default\": 1, \"is_active\": 1},\n                    \"name\"\n                )\n                if not bom:\n                    # لا يوجد BOM => لا ننفذ أي خصم لمواد لهذا المنتج\n                    continue\n\n                # قائمة معالجة (نستخدم قائمة من القوائم لتجنب tuple-unpacking)\n                bom_queue = [[bom, sold_qty]]\n                visited_boms = set()\n\n                # 4) معالجة BOMs متداخلة بشكل iterative\n                while bom_queue:\n                    queue_item = bom_queue.pop(0)\n                    current_bom = queue_item[0]\n                    multiplier = queue_item[1]\n\n                    # حماية ضد المعالجة المتكررة لنفس BOM\n                    if current_bom in visited_boms:\n                        continue\n                    visited_boms.add(current_bom)\n\n                    # جلب بنود الـ BOM (من الكاش إن وُجد)\n                    if current_bom in bom_items_cache:\n                        bom_items = bom_items_cache[current_bom]\n                    else:\n                        bom_items = frappe.get_all(\n                            \"BOM Item\",\n                            filters={\"parent\": current_bom},\n                            fields=[\"item_code\", \"qty\"]\n                        )\n                        bom_items_cache[current_bom] = bom_items\n\n                    # المرور على كل مادة في هذا BOM\n                    for itm in bom_items:\n                        item_code = itm.get(\"item_code\")\n                        base_qty = itm.get(\"qty\") or 0\n                        required_qty = base_qty * multiplier\n\n                        # تجاهل الكميات الصفرية (تمنع رسالة \"Qty in Stock UOM can not be zero\")\n                        if not required_qty:\n                            continue\n\n                        # مفتاح منع التكرار: يربط المنتج النهائي بالمكوّن و BOM الذي جاء منه\n                        key = sold_item + \"::\" + item_code + \"::\" + str(current_bom)\n                        if key in processed_items:\n                            continue\n                        processed_items.add(key)\n\n                        # التحقق من وجود BOM فرعي لهذا العنصر (من الكاش إن وُجد)\n                        if item_code in child_bom_cache:\n                            child_bom = child_bom_cache[item_code]\n                        else:\n                            child_bom = frappe.db.get_value(\n                                \"BOM\",\n                                {\"item\": item_code, \"is_default\": 1, \"is_active\": 1},\n                                \"name\"\n                            )\n                            child_bom_cache[item_code] = child_bom\n\n                        if child_bom:\n                            # أضف BOM الفرعي للمعالجة (نستخدم قائمة بدل tuple)\n                            bom_queue.append([child_bom, required_qty])\n                        else:\n                            # هذه مادة نهائية؛ نخصمها فقط إذا كانت عنصر مخزون\n                            is_stock_item = frappe.db.get_value(\"Item\", item_code, \"is_stock_item\") or 0\n                            if is_stock_item:\n                                final_materials[item_code] = final_materials.get(item_code, 0) + required_qty\n                            else:\n                                # مادة غير مخزنة => لا تُضاف إلى Stock Entry\n                                # (مثال: المنتج النهائي \"فلافل\" هو non-stock)\n                                pass\n\n            # 5) بعد التجميع: تحقق إن كان هناك مواد لخصمها\n            if not final_materials:\n                frappe.msgprint(\"لا توجد مواد مخزنية لخصمها من BOM لهذه الفاتورة\")\n            else:\n                # 6) إنشاء Stock Entry وإضافة كل المواد مباشرة (نسمح بالسالب)\n                se = frappe.new_doc(\"Stock Entry\")\n                se.stock_entry_type = \"Material Issue\"\n                se.company = doc.company\n                se.from_warehouse = pos_wh\n                se.reference_doctype = \"Sales Invoice\"\n                se.reference_name = doc.name\n\n                for item_code, qty in final_materials.items():\n                    # تأكد من الحصول على UOM التخزين الافتراضي\n                    item_uom = frappe.db.get_value(\"Item\", item_code, \"stock_uom\") or \"Unit\"\n\n                    # إضافة المادة - لا نتحقق من Bin.actual_qty هنا لأننا نسمح بالسالب\n                    se.append(\"items\", {\n                        \"item_code\": item_code,\n                        \"qty\": qty,\n                        \"uom\": item_uom,\n                        \"s_warehouse\": pos_wh\n                    })\n\n                # حفظ وإرسال Stock Entry إن كانت هناك بنود\n                if se.items:\n                    se.insert(ignore_permissions=True)\n                    se.submit()\n                    # رسالة بسيطة للمستخدم\n                    frappe.msgprint(\"تم إنشاء Stock Entry وخصم المواد المخزنية بنجاح. Stock Entry: \" + str(se.name))\n                else:\n                    frappe.msgprint(\"لم يتم إضافة أي بند إلى Stock Entry\")\n\n    except Exception as e:\n        # سجل الخطأ وأظهر رسالة عامة (تجنب استخدام .format هنا)\n        frappe.log_error(\"Auto BOM Consumption Error: \" + str(e), \"bom_consumption_pos\")\n        frappe.msgprint(\"حدث خطأ أثناء تنفيذ خصم المواد: \" + str(e), indicator=\"red\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-01-18 20:13:36.967422",
  "module": "Restaurant Expert",
  "name": "Set_guests_count",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "POS Invoice",
  "script": "if doc.custom_guests_count is None:\n    doc.custom_guests_count = 1\n\nif  doc.custom_guests_count <= 0:\n  doc.custom_guests_count = 1",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:29:17.892047",
  "module": "Restaurant Expert",
  "name": "Alarm_order_type",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "POS Invoice",
  "script": "if doc.custom_order_type is None:\n    frappe.throw(\"Important !! \\nYou Must To Select Order Type.\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-01-25 03:43:24.552863",
  "module": "Restaurant Expert",
  "name": "TypeOrder",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "POS Invoice",
  "script": "if doc.custom_order_type is None:\n    doc.custom_order_type = 'Hasan'\n    doc.custom_order_type = ''\n    doc.custom_type = 'Hasan'\n    doc.custom_type = ''",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:13:48.191906",
  "module": "Restaurant Expert",
  "name": "Auto Production By Sales Invoice",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "Entry\nfor item in doc.items:\n    # البحث عن BOM نشط وافتراضي\n    bom = frappe.db.get_value(\"BOM\", {\n        \"item\": item.item_code,\n        \"is_active\": 1,\n        \"is_default\": 1\n    }, \"name\")\n    \n    if bom:\n        try:\n            # الحصول على تفاصيل BOM\n            bom_doc = frappe.get_doc(\"BOM\", bom)\n            \n            # التحقق من وجود مستودعات في BOM\n            source_warehouse = None\n            target_warehouse = None\n            \n            # البحث عن المستودعات من أول مكون في BOM\n            if bom_doc.items:\n                source_warehouse = bom_doc.items[0].source_warehouse\n            \n            # الحصول على المستودع الهدف من الصنف\n            target_warehouse = frappe.db.get_value(\"Item Default\", {\n                \"parent\": item.item_code,\n                \"company\": doc.company\n            }, \"default_warehouse\")\n            \n            # إنشاء Stock Entry\n            stock_entry = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"from_bom\": 1,\n                \"bom_no\": bom,\n                \"use_multi_level_bom\": 1,\n                \"fg_completed_qty\": item.qty,\n                \"from_warehouse\": source_warehouse,\n                \"to_warehouse\": target_warehouse\n            })\n            \n            # جلب المكونات من BOM\n            stock_entry.get_items()\n            \n            # تعيين المستودعات يدوياً إذا لزم الأمر\n            for se_item in stock_entry.items:\n                if se_item.s_warehouse and not se_item.t_warehouse:\n                    # هذا مكون خام - يحتاج source warehouse فقط\n                    if not se_item.s_warehouse:\n                        se_item.s_warehouse = source_warehouse\n                elif se_item.is_finished_item:\n                    # هذا منتج نهائي - يحتاج target warehouse فقط\n                    if not se_item.t_warehouse:\n                        se_item.t_warehouse = target_warehouse\n            \n            # حفظ وتأكيد\n            stock_entry.flags.ignore_permissions = True\n            stock_entry.insert()\n            stock_entry.submit()\n            \n            # ربط مع فاتورة البيع\n            frappe.db.set_value(\"Stock Entry\", stock_entry.name, \n                              \"sales_invoice\", doc.name)\n            \n            # رسالة نجاح\n            frappe.msgprint(\n                f\"تم خصم مكونات {item.item_name} بنجاح - رقم الحركة: {stock_entry.name}\",\n                indicator=\"green\"\n            )\n            \n        except Exception as e:\n            # تسجيل الخطأ بالتفصيل\n            error_message = f\"\"\"\n            خطأ في خصم مكونات الصنف: {item.item_code}\n            BOM: {bom}\n            الخطأ: {str(e)}\n            \"\"\"\n            frappe.log_error(message=error_message, title=\"خطأ خصم المكونات\")\n            \n            # إظهار رسالة للمستخدم\n            frappe.msgprint(\n                f\"تعذر خصم مكونات {item.item_name} تلقائياً. <br>الخطأ: {str(e)}<br>يرجى الخصم يدوياً.\",\n                indicator=\"red\",\n                alert=True\n            )\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:24:33.180253",
  "module": "Restaurant Expert",
  "name": "Auto Deduct Ingredients",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# خصم المكونات تلقائياً من المخزون بعد البيع\n# تأكد من عدم وجود أي أخطاء في الكود\n\nfor item in doc.items:\n    # البحث عن BOM للصنف\n    bom_name = frappe.db.get_value(\"BOM\", {\n        \"item\": item.item_code,\n        \"is_active\": 1,\n        \"is_default\": 1\n    }, \"name\")\n    \n    if bom_name:\n        try:\n            # الحصول على بيانات BOM\n            bom = frappe.get_doc(\"BOM\", bom_name)\n            \n            # تحديد المستودعات\n            source_warehouse = None\n            target_warehouse = None\n            \n            # البحث عن المستودع المصدر من أول عنصر في BOM\n            if bom.items and len(bom.items) > 0:\n                source_warehouse = bom.items[0].source_warehouse\n            \n            # إذا لم يكن محدد، استخدم المستودع الافتراضي\n            if not source_warehouse:\n                source_warehouse = frappe.db.get_value(\"Item Default\", {\n                    \"parent\": bom.items[0].item_code,\n                    \"company\": doc.company\n                }, \"default_warehouse\")\n            \n            # الحصول على المستودع الهدف\n            target_warehouse = frappe.db.get_value(\"Item Default\", {\n                \"parent\": item.item_code,\n                \"company\": doc.company\n            }, \"default_warehouse\")\n            \n            # إنشاء Stock Entry\n            se = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": bom_name,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 1\n            })\n            \n            # جلب العناصر من BOM\n            se.get_items()\n            \n            # تعيين المستودعات\n            for se_item in se.items:\n                if se_item.s_warehouse:\n                    # مكون خام - يحتاج source warehouse\n                    if not se_item.s_warehouse and source_warehouse:\n                        se_item.s_warehouse = source_warehouse\n                \n                if se_item.is_finished_item or se_item.t_warehouse:\n                    # منتج نهائي - يحتاج target warehouse\n                    if not se_item.t_warehouse and target_warehouse:\n                        se_item.t_warehouse = target_warehouse\n            \n            # الحفظ والتأكيد\n            se.flags.ignore_permissions = True\n            se.insert()\n            se.submit()\n            \n            # ربط Stock Entry مع Sales Invoice\n            frappe.db.set_value(\"Stock Entry\", se.name, \"sales_invoice\", doc.name)\n            frappe.db.commit()\n            \n        except Exception as e:\n            # تسجيل الخطأ\n            error_msg = \"خطأ في خصم مكونات: {0}\\nBOM: {1}\\nالخطأ: {2}\".format(\n                item.item_name, \n                bom_name, \n                str(e)\n            )\n            frappe.log_error(message=error_msg, title=\"فشل خصم المكونات\")\n            \n            # إظهار رسالة تحذيرية فقط دون إيقاف العملية\n            frappe.msgprint(\n                \"تعذر خصم مكونات {0} تلقائياً. يرجى المراجعة يدوياً.\".format(item.item_name),\n                indicator=\"orange\",\n                alert=True\n            )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:29:10.318064",
  "module": "Restaurant Expert",
  "name": "Auto_Deduction_QTY_BOM",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# نسخة مبسطة - تتجاهل الأخطاء\nfor item in doc.items:\n    bom = frappe.db.get_value(\"BOM\", {\n        \"item\": item.item_code,\n        \"is_active\": 1,\n        \"is_default\": 1\n    })\n    \n    if bom:\n        try:\n            se = frappe.new_doc(\"Stock Entry\")\n            se.stock_entry_type = \"Manufacture\"\n            se.company = doc.company\n            se.bom_no = bom\n            se.fg_completed_qty = item.qty\n            se.get_items()\n            se.save()\n            se.submit()\n        except:\n            pass  # تجاهل الأخطاء",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 21:33:52.418000",
  "module": "Restaurant Expert",
  "name": "Auto_New_BOM",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# AUTO DEDUCT INGREDIENTS — SAFE VERSION (NO TOP-LEVEL RETURN)\n\ndef get_item_size_from_row(item_row):\n    for key in (\"size\", \"item_size\", \"variant\", \"item_variant\", \"size_option\"):\n        if item_row.get(key):\n            return str(item_row.get(key)).strip()\n    return None\n\ndef choose_bom_for_item(item_code, size_value, company):\n    boms = frappe.get_all(\n        \"BOM\",\n        filters={\"item\": item_code, \"is_active\": 1},\n        fields=[\"name\", \"is_default\"]\n    )\n    if not boms:\n        return None\n\n    if size_value:\n        sv_lower = size_value.lower()\n        for b in boms:\n            if sv_lower in (b.get(\"name\") or \"\").lower():\n                return b.get(\"name\")\n\n    for b in boms:\n        bom_doc = frappe.get_doc(\"BOM\", b.name)\n        if bom_doc.get(\"bom_size\"):\n            if str(bom_doc.get(\"bom_size\")).strip().lower() == (size_value or \"\").strip().lower():\n                return b.name\n\n    for b in boms:\n        if b.get(\"is_default\"):\n            return b.get(\"name\")\n\n    return boms[0].get(\"name\")\n\ndef create_communication_log(si_doc, content):\n    try:\n        comm = frappe.get_doc({\n            \"doctype\": \"Communication\",\n            \"communication_type\": \"Comment\",\n            \"subject\": \"Auto Deduct Ingredients\",\n            \"content\": content,\n            \"reference_doctype\": \"Sales Invoice\",\n            \"reference_name\": si_doc.name,\n            \"sent_or_received\": \"Sent\"\n        })\n        comm.flags.ignore_permissions = True\n        comm.insert()\n    except Exception as e:\n        frappe.log_error(\"Failed to create communication: \" + str(e))\n\n# ======= Guard: only run main block when POS =======\nif not doc.get(\"is_pos\"):\n    # لا تستخدم return على مستوى الموديول — فقط سجل وتجاهل تنفيذ البلوك الرئيسي\n    frappe.log(\"Auto Deduct skipped (not POS)\", \"auto_deduct\")\nelse:\n    log_entries = []\n\n    for item in doc.items:\n        try:\n            size_val = get_item_size_from_row(item)\n            bom_name = choose_bom_for_item(item.item_code, size_val, doc.company)\n\n            if not bom_name:\n                log_entries.append(\"لا يوجد BOM للمنتج \" + item.item_code)\n                continue\n\n            bom = frappe.get_doc(\"BOM\", bom_name)\n\n            if not bom.items:\n                log_entries.append(\"BOM \" + bom_name + \" ليس به مكونات.\")\n                continue\n\n            # Determine warehouses\n            source_warehouse = None\n            if bom.items:\n                first = bom.items[0]\n                source_warehouse = first.get(\"source_warehouse\") or frappe.db.get_value(\n                    \"Item Default\",\n                    {\"parent\": first.get(\"item_code\"), \"company\": doc.company},\n                    \"default_warehouse\"\n                )\n\n            target_warehouse = (\n                item.get(\"warehouse\") or\n                frappe.db.get_value(\n                    \"Item Default\",\n                    {\"parent\": item.item_code, \"company\": doc.company},\n                    \"default_warehouse\"\n                )\n            )\n\n            # Temp Manufacture SE to extract raw items\n            se_temp = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": bom_name,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 1\n            })\n            se_temp.get_items()\n\n            for s in se_temp.items:\n                if not s.get(\"is_finished_item\"):\n                    if not s.get(\"s_warehouse\"):\n                        s.s_warehouse = source_warehouse\n                else:\n                    if not s.get(\"t_warehouse\"):\n                        s.t_warehouse = target_warehouse\n\n            raw_items = [ri for ri in se_temp.items if not ri.get(\"is_finished_item\")]\n\n            # Create Material Issue\n            se_issue_name = None\n            if raw_items:\n                se_issue = frappe.get_doc({\n                    \"doctype\": \"Stock Entry\",\n                    \"stock_entry_type\": \"Material Issue\",\n                    \"company\": doc.company,\n                    \"posting_date\": doc.posting_date,\n                    \"posting_time\": doc.posting_time,\n                    \"set_posting_time\": 1\n                })\n                for ri in raw_items:\n                    se_issue.append(\"items\", {\n                        \"item_code\": ri.item_code,\n                        \"qty\": ri.qty,\n                        \"uom\": ri.uom,\n                        \"stock_uom\": ri.stock_uom,\n                        \"conversion_factor\": ri.conversion_factor,\n                        \"s_warehouse\": ri.s_warehouse or source_warehouse\n                    })\n\n                se_issue.flags.ignore_permissions = True\n                se_issue.insert()\n                se_issue.submit()\n                se_issue_name = se_issue.name\n                log_entries.append(\"Material Issue تم إنشاؤه: \" + se_issue_name)\n\n            # Create Manufacture FG\n            se_fg = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": bom_name,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 0\n            })\n\n            se_fg.append(\"items\", {\n                \"item_code\": item.item_code,\n                \"qty\": item.qty,\n                \"is_finished_item\": 1,\n                \"t_warehouse\": target_warehouse\n            })\n\n            se_fg.flags.ignore_permissions = True\n            se_fg.insert()\n            se_fg.submit()\n\n            log_entries.append(\"FG Manufacture تم إنشاؤه: \" + se_fg.name)\n\n            # Log per item\n            create_communication_log(\n                doc,\n                \"Auto Deduct: \" + item.item_code +\n                \"<br>Material Issue: \" + (se_issue_name or \"N/A\") +\n                \"<br>Manufacture: \" + se_fg.name\n            )\n\n        except Exception as e:\n            frappe.log_error(\"Auto Deduct Error: \" + str(e))\n            log_entries.append(\"خطأ: \" + item.item_code + \" — \" + str(e))\n\n    # Final summary log\n    if log_entries:\n        summary = \"<br>\".join(log_entries)\n        create_communication_log(doc, \"<b>Auto Deduct Summary</b><br>\" + summary)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-18 17:05:29.734981",
  "module": "Restaurant Expert",
  "name": "BOM_Deduction",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Server Script for Sales Invoice - On Submit\n# FINAL CORRECTED VERSION\n\n# Le script s'exécute uniquement pour les factures de point de vente soumises\nif doc.is_pos and doc.docstatus == 1:\n    \n    log_entries = []\n    has_errors = False\n\n    try:\n        # 1. Obtenir l'entrepôt du profil de point de vente\n        pos_warehouse = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        if not pos_warehouse:\n            raise Exception(\"Entrepôt du profil de point de vente non défini.\")\n\n        # 2. Parcourir chaque article de la facture\n        for item in doc.items:\n            # Ignorer les articles qui ne sont pas en stock\n            if not frappe.db.get_value(\"Item\", item.item_code, \"is_stock_item\"):\n                continue\n\n            # 3. Trouver la nomenclature par défaut pour l'article\n            default_bom = frappe.db.get_value(\"Item\", item.item_code, \"default_bom\")\n            if not default_bom:\n                log_entries.append(f\"Avertissement : L'article '{item.item_name}' a été ignoré car il n'a pas de nomenclature par défaut.\")\n                continue\n\n            # 4. Créer une seule entrée de stock de fabrication (prend en charge les nomenclatures à plusieurs niveaux)\n            se = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"purpose\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": default_bom,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 1,\n                \"sales_invoice_no\": doc.name,  # Important pour le suivi\n            })\n\n            # 5. Obtenir les articles de la nomenclature et définir les entrepôts\n            se.get_bom_items()\n            \n            for se_item in se.items:\n                if se_item.is_finished_item:\n                    # Le produit fini est \"reçu\" dans l'entrepôt du point de vente (Backflush)\n                    se_item.t_warehouse = pos_warehouse\n                else:\n                    # Les matières premières sont \"prélevées\" de leur entrepôt source\n                    source_warehouse = frappe.db.get_value(\n                        \"Item Default\", {\"parent\": se_item.item_code, \"company\": doc.company}, \"default_warehouse\"\n                    )\n                    se_item.s_warehouse = source_warehouse or pos_warehouse\n\n            # 6. Sauvegarder et soumettre l'entrée de stock\n            se.insert(ignore_permissions=True)\n            se.submit()\n            \n            log_entries.append(f\"Entrée de stock <a href='/app/stock-entry/{se.name}' target='_blank'>{se.name}</a> créée pour l'article '{item.item_name}'.\")\n\n    except Exception as e:\n        has_errors = True\n        frappe.log_error(title=\"Erreur du script de fabrication automatique de point de vente\", message=frappe.get_traceback())\n        log_entries.append(f\"<b>Une erreur fatale s'est produite. Erreur : {e}</b>\")\n        # Ne pas afficher de message popup car cela peut interrompre le processus de clôture du point de vente\n\n    finally:\n        # 7. Enregistrer un résumé dans le journal de communication\n        if log_entries:\n            summary_header = f\"<b>Résumé du processus de déduction automatique ({now()})</b><br>\"\n            summary_body = \"<br>\".join(log_entries)\n            \n            frappe.get_doc({\n                \"doctype\": \"Communication\", \"communication_type\": \"Comment\", \"comment_type\": \"Info\",\n                \"subject\": f\"Journal de déduction des composants pour la facture {doc.name}\",\n                \"content\": summary_header + summary_body,\n                \"reference_doctype\": doc.doctype, \"reference_name\": doc.name,\n            }).insert(ignore_permissions=True)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-05 15:29:14.052741",
  "module": "Restaurant Expert",
  "name": "Edit_SKU_WIP_FINAL_Numbers",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "#SKU\n#يخزن + يشترى + يباع\n#يخزن + يشترى + لا يباع\n#WIP\n#يخزن + لا يشترى + لا يباع\n#FINAL\n#لا يخزن + لا يشترى + يباع\n#لا يخزن + يشترى + يباع\n#STO\n#########################################\n\n# WIP - نصف مصنع\nif doc.is_stock_item and not doc.is_purchase_item and not doc.is_sales_item:\n    doc.naming_series = \"WIP-.####\"\n\n# SKU - مادة خام أو منتج مخزني\nelif doc.is_stock_item and doc.is_purchase_item:\n    doc.naming_series = \"SKU-.####\"\n\n# FINAL - منتج نهائي غير مخزني\nelif not doc.is_stock_item and doc.is_sales_item:\n    doc.naming_series = \"FINAL-.####\"\n",
  "script_type": "DocType Event"
 }
]