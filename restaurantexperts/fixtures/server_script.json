[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-01-18 20:13:36.967422",
  "module": "Restaurant Expert",
  "name": "Set_guests_count",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "POS Invoice",
  "script": "if doc.custom_guests_count is None:\n    doc.custom_guests_count = 1\n\nif  doc.custom_guests_count <= 0:\n  doc.custom_guests_count = 1",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:29:17.892047",
  "module": "Restaurant Expert",
  "name": "Alarm_order_type",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "POS Invoice",
  "script": "if doc.custom_order_type is None:\n    frappe.throw(\"Important !! \\nYou Must To Select Order Type.\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-01-25 03:43:24.552863",
  "module": "Restaurant Expert",
  "name": "TypeOrder",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "POS Invoice",
  "script": "if doc.custom_order_type is None:\n    doc.custom_order_type = 'Hasan'\n    doc.custom_order_type = ''\n    doc.custom_type = 'Hasan'\n    doc.custom_type = ''",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:13:48.191906",
  "module": "Restaurant Expert",
  "name": "Auto Production By Sales Invoice",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "Entry\nfor item in doc.items:\n    # البحث عن BOM نشط وافتراضي\n    bom = frappe.db.get_value(\"BOM\", {\n        \"item\": item.item_code,\n        \"is_active\": 1,\n        \"is_default\": 1\n    }, \"name\")\n    \n    if bom:\n        try:\n            # الحصول على تفاصيل BOM\n            bom_doc = frappe.get_doc(\"BOM\", bom)\n            \n            # التحقق من وجود مستودعات في BOM\n            source_warehouse = None\n            target_warehouse = None\n            \n            # البحث عن المستودعات من أول مكون في BOM\n            if bom_doc.items:\n                source_warehouse = bom_doc.items[0].source_warehouse\n            \n            # الحصول على المستودع الهدف من الصنف\n            target_warehouse = frappe.db.get_value(\"Item Default\", {\n                \"parent\": item.item_code,\n                \"company\": doc.company\n            }, \"default_warehouse\")\n            \n            # إنشاء Stock Entry\n            stock_entry = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"from_bom\": 1,\n                \"bom_no\": bom,\n                \"use_multi_level_bom\": 1,\n                \"fg_completed_qty\": item.qty,\n                \"from_warehouse\": source_warehouse,\n                \"to_warehouse\": target_warehouse\n            })\n            \n            # جلب المكونات من BOM\n            stock_entry.get_items()\n            \n            # تعيين المستودعات يدوياً إذا لزم الأمر\n            for se_item in stock_entry.items:\n                if se_item.s_warehouse and not se_item.t_warehouse:\n                    # هذا مكون خام - يحتاج source warehouse فقط\n                    if not se_item.s_warehouse:\n                        se_item.s_warehouse = source_warehouse\n                elif se_item.is_finished_item:\n                    # هذا منتج نهائي - يحتاج target warehouse فقط\n                    if not se_item.t_warehouse:\n                        se_item.t_warehouse = target_warehouse\n            \n            # حفظ وتأكيد\n            stock_entry.flags.ignore_permissions = True\n            stock_entry.insert()\n            stock_entry.submit()\n            \n            # ربط مع فاتورة البيع\n            frappe.db.set_value(\"Stock Entry\", stock_entry.name, \n                              \"sales_invoice\", doc.name)\n            \n            # رسالة نجاح\n            frappe.msgprint(\n                f\"تم خصم مكونات {item.item_name} بنجاح - رقم الحركة: {stock_entry.name}\",\n                indicator=\"green\"\n            )\n            \n        except Exception as e:\n            # تسجيل الخطأ بالتفصيل\n            error_message = f\"\"\"\n            خطأ في خصم مكونات الصنف: {item.item_code}\n            BOM: {bom}\n            الخطأ: {str(e)}\n            \"\"\"\n            frappe.log_error(message=error_message, title=\"خطأ خصم المكونات\")\n            \n            # إظهار رسالة للمستخدم\n            frappe.msgprint(\n                f\"تعذر خصم مكونات {item.item_name} تلقائياً. <br>الخطأ: {str(e)}<br>يرجى الخصم يدوياً.\",\n                indicator=\"red\",\n                alert=True\n            )\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:24:33.180253",
  "module": "Restaurant Expert",
  "name": "Auto Deduct Ingredients",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# خصم المكونات تلقائياً من المخزون بعد البيع\n# تأكد من عدم وجود أي أخطاء في الكود\n\nfor item in doc.items:\n    # البحث عن BOM للصنف\n    bom_name = frappe.db.get_value(\"BOM\", {\n        \"item\": item.item_code,\n        \"is_active\": 1,\n        \"is_default\": 1\n    }, \"name\")\n    \n    if bom_name:\n        try:\n            # الحصول على بيانات BOM\n            bom = frappe.get_doc(\"BOM\", bom_name)\n            \n            # تحديد المستودعات\n            source_warehouse = None\n            target_warehouse = None\n            \n            # البحث عن المستودع المصدر من أول عنصر في BOM\n            if bom.items and len(bom.items) > 0:\n                source_warehouse = bom.items[0].source_warehouse\n            \n            # إذا لم يكن محدد، استخدم المستودع الافتراضي\n            if not source_warehouse:\n                source_warehouse = frappe.db.get_value(\"Item Default\", {\n                    \"parent\": bom.items[0].item_code,\n                    \"company\": doc.company\n                }, \"default_warehouse\")\n            \n            # الحصول على المستودع الهدف\n            target_warehouse = frappe.db.get_value(\"Item Default\", {\n                \"parent\": item.item_code,\n                \"company\": doc.company\n            }, \"default_warehouse\")\n            \n            # إنشاء Stock Entry\n            se = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": bom_name,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 1\n            })\n            \n            # جلب العناصر من BOM\n            se.get_items()\n            \n            # تعيين المستودعات\n            for se_item in se.items:\n                if se_item.s_warehouse:\n                    # مكون خام - يحتاج source warehouse\n                    if not se_item.s_warehouse and source_warehouse:\n                        se_item.s_warehouse = source_warehouse\n                \n                if se_item.is_finished_item or se_item.t_warehouse:\n                    # منتج نهائي - يحتاج target warehouse\n                    if not se_item.t_warehouse and target_warehouse:\n                        se_item.t_warehouse = target_warehouse\n            \n            # الحفظ والتأكيد\n            se.flags.ignore_permissions = True\n            se.insert()\n            se.submit()\n            \n            # ربط Stock Entry مع Sales Invoice\n            frappe.db.set_value(\"Stock Entry\", se.name, \"sales_invoice\", doc.name)\n            frappe.db.commit()\n            \n        except Exception as e:\n            # تسجيل الخطأ\n            error_msg = \"خطأ في خصم مكونات: {0}\\nBOM: {1}\\nالخطأ: {2}\".format(\n                item.item_name, \n                bom_name, \n                str(e)\n            )\n            frappe.log_error(message=error_msg, title=\"فشل خصم المكونات\")\n            \n            # إظهار رسالة تحذيرية فقط دون إيقاف العملية\n            frappe.msgprint(\n                \"تعذر خصم مكونات {0} تلقائياً. يرجى المراجعة يدوياً.\".format(item.item_name),\n                indicator=\"orange\",\n                alert=True\n            )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 20:29:10.318064",
  "module": "Restaurant Expert",
  "name": "Auto_Deduction_QTY_BOM",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# نسخة مبسطة - تتجاهل الأخطاء\nfor item in doc.items:\n    bom = frappe.db.get_value(\"BOM\", {\n        \"item\": item.item_code,\n        \"is_active\": 1,\n        \"is_default\": 1\n    })\n    \n    if bom:\n        try:\n            se = frappe.new_doc(\"Stock Entry\")\n            se.stock_entry_type = \"Manufacture\"\n            se.company = doc.company\n            se.bom_no = bom\n            se.fg_completed_qty = item.qty\n            se.get_items()\n            se.save()\n            se.submit()\n        except:\n            pass  # تجاهل الأخطاء",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 21:33:52.418000",
  "module": "Restaurant Expert",
  "name": "Auto_New_BOM",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# AUTO DEDUCT INGREDIENTS — SAFE VERSION (NO TOP-LEVEL RETURN)\n\ndef get_item_size_from_row(item_row):\n    for key in (\"size\", \"item_size\", \"variant\", \"item_variant\", \"size_option\"):\n        if item_row.get(key):\n            return str(item_row.get(key)).strip()\n    return None\n\ndef choose_bom_for_item(item_code, size_value, company):\n    boms = frappe.get_all(\n        \"BOM\",\n        filters={\"item\": item_code, \"is_active\": 1},\n        fields=[\"name\", \"is_default\"]\n    )\n    if not boms:\n        return None\n\n    if size_value:\n        sv_lower = size_value.lower()\n        for b in boms:\n            if sv_lower in (b.get(\"name\") or \"\").lower():\n                return b.get(\"name\")\n\n    for b in boms:\n        bom_doc = frappe.get_doc(\"BOM\", b.name)\n        if bom_doc.get(\"bom_size\"):\n            if str(bom_doc.get(\"bom_size\")).strip().lower() == (size_value or \"\").strip().lower():\n                return b.name\n\n    for b in boms:\n        if b.get(\"is_default\"):\n            return b.get(\"name\")\n\n    return boms[0].get(\"name\")\n\ndef create_communication_log(si_doc, content):\n    try:\n        comm = frappe.get_doc({\n            \"doctype\": \"Communication\",\n            \"communication_type\": \"Comment\",\n            \"subject\": \"Auto Deduct Ingredients\",\n            \"content\": content,\n            \"reference_doctype\": \"Sales Invoice\",\n            \"reference_name\": si_doc.name,\n            \"sent_or_received\": \"Sent\"\n        })\n        comm.flags.ignore_permissions = True\n        comm.insert()\n    except Exception as e:\n        frappe.log_error(\"Failed to create communication: \" + str(e))\n\n# ======= Guard: only run main block when POS =======\nif not doc.get(\"is_pos\"):\n    # لا تستخدم return على مستوى الموديول — فقط سجل وتجاهل تنفيذ البلوك الرئيسي\n    frappe.log(\"Auto Deduct skipped (not POS)\", \"auto_deduct\")\nelse:\n    log_entries = []\n\n    for item in doc.items:\n        try:\n            size_val = get_item_size_from_row(item)\n            bom_name = choose_bom_for_item(item.item_code, size_val, doc.company)\n\n            if not bom_name:\n                log_entries.append(\"لا يوجد BOM للمنتج \" + item.item_code)\n                continue\n\n            bom = frappe.get_doc(\"BOM\", bom_name)\n\n            if not bom.items:\n                log_entries.append(\"BOM \" + bom_name + \" ليس به مكونات.\")\n                continue\n\n            # Determine warehouses\n            source_warehouse = None\n            if bom.items:\n                first = bom.items[0]\n                source_warehouse = first.get(\"source_warehouse\") or frappe.db.get_value(\n                    \"Item Default\",\n                    {\"parent\": first.get(\"item_code\"), \"company\": doc.company},\n                    \"default_warehouse\"\n                )\n\n            target_warehouse = (\n                item.get(\"warehouse\") or\n                frappe.db.get_value(\n                    \"Item Default\",\n                    {\"parent\": item.item_code, \"company\": doc.company},\n                    \"default_warehouse\"\n                )\n            )\n\n            # Temp Manufacture SE to extract raw items\n            se_temp = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": bom_name,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 1\n            })\n            se_temp.get_items()\n\n            for s in se_temp.items:\n                if not s.get(\"is_finished_item\"):\n                    if not s.get(\"s_warehouse\"):\n                        s.s_warehouse = source_warehouse\n                else:\n                    if not s.get(\"t_warehouse\"):\n                        s.t_warehouse = target_warehouse\n\n            raw_items = [ri for ri in se_temp.items if not ri.get(\"is_finished_item\")]\n\n            # Create Material Issue\n            se_issue_name = None\n            if raw_items:\n                se_issue = frappe.get_doc({\n                    \"doctype\": \"Stock Entry\",\n                    \"stock_entry_type\": \"Material Issue\",\n                    \"company\": doc.company,\n                    \"posting_date\": doc.posting_date,\n                    \"posting_time\": doc.posting_time,\n                    \"set_posting_time\": 1\n                })\n                for ri in raw_items:\n                    se_issue.append(\"items\", {\n                        \"item_code\": ri.item_code,\n                        \"qty\": ri.qty,\n                        \"uom\": ri.uom,\n                        \"stock_uom\": ri.stock_uom,\n                        \"conversion_factor\": ri.conversion_factor,\n                        \"s_warehouse\": ri.s_warehouse or source_warehouse\n                    })\n\n                se_issue.flags.ignore_permissions = True\n                se_issue.insert()\n                se_issue.submit()\n                se_issue_name = se_issue.name\n                log_entries.append(\"Material Issue تم إنشاؤه: \" + se_issue_name)\n\n            # Create Manufacture FG\n            se_fg = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"stock_entry_type\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": bom_name,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 0\n            })\n\n            se_fg.append(\"items\", {\n                \"item_code\": item.item_code,\n                \"qty\": item.qty,\n                \"is_finished_item\": 1,\n                \"t_warehouse\": target_warehouse\n            })\n\n            se_fg.flags.ignore_permissions = True\n            se_fg.insert()\n            se_fg.submit()\n\n            log_entries.append(\"FG Manufacture تم إنشاؤه: \" + se_fg.name)\n\n            # Log per item\n            create_communication_log(\n                doc,\n                \"Auto Deduct: \" + item.item_code +\n                \"<br>Material Issue: \" + (se_issue_name or \"N/A\") +\n                \"<br>Manufacture: \" + se_fg.name\n            )\n\n        except Exception as e:\n            frappe.log_error(\"Auto Deduct Error: \" + str(e))\n            log_entries.append(\"خطأ: \" + item.item_code + \" — \" + str(e))\n\n    # Final summary log\n    if log_entries:\n        summary = \"<br>\".join(log_entries)\n        create_communication_log(doc, \"<b>Auto Deduct Summary</b><br>\" + summary)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-17 23:10:28.690848",
  "module": "Restaurant Expert",
  "name": "BOM_Deduction",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Server Script for Sales Invoice - On Submit\n# FINAL CORRECTED VERSION\n\n# Le script s'exécute uniquement pour les factures de point de vente soumises\nif doc.is_pos and doc.docstatus == 1:\n    \n    log_entries = []\n    has_errors = False\n\n    try:\n        # 1. Obtenir l'entrepôt du profil de point de vente\n        pos_warehouse = frappe.db.get_value(\"POS Profile\", doc.pos_profile, \"warehouse\")\n        if not pos_warehouse:\n            raise Exception(\"Entrepôt du profil de point de vente non défini.\")\n\n        # 2. Parcourir chaque article de la facture\n        for item in doc.items:\n            # Ignorer les articles qui ne sont pas en stock\n            if not frappe.db.get_value(\"Item\", item.item_code, \"is_stock_item\"):\n                continue\n\n            # 3. Trouver la nomenclature par défaut pour l'article\n            default_bom = frappe.db.get_value(\"Item\", item.item_code, \"default_bom\")\n            if not default_bom:\n                log_entries.append(f\"Avertissement : L'article '{item.item_name}' a été ignoré car il n'a pas de nomenclature par défaut.\")\n                continue\n\n            # 4. Créer une seule entrée de stock de fabrication (prend en charge les nomenclatures à plusieurs niveaux)\n            se = frappe.get_doc({\n                \"doctype\": \"Stock Entry\",\n                \"purpose\": \"Manufacture\",\n                \"company\": doc.company,\n                \"posting_date\": doc.posting_date,\n                \"posting_time\": doc.posting_time,\n                \"set_posting_time\": 1,\n                \"bom_no\": default_bom,\n                \"fg_completed_qty\": item.qty,\n                \"use_multi_level_bom\": 1,\n                \"sales_invoice_no\": doc.name,  # Important pour le suivi\n            })\n\n            # 5. Obtenir les articles de la nomenclature et définir les entrepôts\n            se.get_bom_items()\n            \n            for se_item in se.items:\n                if se_item.is_finished_item:\n                    # Le produit fini est \"reçu\" dans l'entrepôt du point de vente (Backflush)\n                    se_item.t_warehouse = pos_warehouse\n                else:\n                    # Les matières premières sont \"prélevées\" de leur entrepôt source\n                    source_warehouse = frappe.db.get_value(\n                        \"Item Default\", {\"parent\": se_item.item_code, \"company\": doc.company}, \"default_warehouse\"\n                    )\n                    se_item.s_warehouse = source_warehouse or pos_warehouse\n\n            # 6. Sauvegarder et soumettre l'entrée de stock\n            se.insert(ignore_permissions=True)\n            se.submit()\n            \n            log_entries.append(f\"Entrée de stock <a href='/app/stock-entry/{se.name}' target='_blank'>{se.name}</a> créée pour l'article '{item.item_name}'.\")\n\n    except Exception as e:\n        has_errors = True\n        frappe.log_error(title=\"Erreur du script de fabrication automatique de point de vente\", message=frappe.get_traceback())\n        log_entries.append(f\"<b>Une erreur fatale s'est produite. Erreur : {e}</b>\")\n        # Ne pas afficher de message popup car cela peut interrompre le processus de clôture du point de vente\n\n    finally:\n        # 7. Enregistrer un résumé dans le journal de communication\n        if log_entries:\n            summary_header = f\"<b>Résumé du processus de déduction automatique ({now()})</b><br>\"\n            summary_body = \"<br>\".join(log_entries)\n            \n            frappe.get_doc({\n                \"doctype\": \"Communication\", \"communication_type\": \"Comment\", \"comment_type\": \"Info\",\n                \"subject\": f\"Journal de déduction des composants pour la facture {doc.name}\",\n                \"content\": summary_header + summary_body,\n                \"reference_doctype\": doc.doctype, \"reference_name\": doc.name,\n            }).insert(ignore_permissions=True)",
  "script_type": "DocType Event"
 }
]